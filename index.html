<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Honey ‚Äî Sabrina ¬∑ Honey Garden (School Room)</title>
<link rel="canonical" href="https://honey.plnt.earth/"/>
<meta name="theme-color" content="#0b0d11"/>
<meta name="description" content="Honey ‚Äî Sabrina‚Äôs school room. One-tap Start Honey, player + queue, Honey 128 Hz tone, Warmth Placement Test, playful school tools. Sabrina wit first."/>
<meta name="keywords" content="Honey,Sabrina Carpenter,128 Hz,School,PLNT Earth,Illumina,Tunes style,player,queue,metronome,syllabus"/>

<meta property="og:title" content="Honey ‚Äî Sabrina ¬∑ Honey Garden"/>
<meta property="og:description" content="Start Honey to enable audio. Tunes-style player + queue, Honey 128 Hz tone, Warmth Test, school tools."/>
<meta property="og:type" content="website"/>
<meta property="og:url" content="https://honey.plnt.earth/"/>
<meta property="og:image" content="https://tunes.plnt.earth/og.png"/>

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:title" content="Honey ‚Äî Sabrina ¬∑ Honey Garden"/>
<meta name="twitter:description" content="One-tap Start Honey ¬∑ player + queue ¬∑ Honey 128 Hz ¬∑ Warmth Test ¬∑ school tools."/>
<meta name="twitter:image" content="https://tunes.plnt.earth/og.png"/>

<style>
  :root{
    --bg:#0b0d11; --ink:#e9ecf4; --muted:#a8b0c2; --card:#101626; --ring:#1b2134;
    --mint:#b2f5ea; --vio:#b7a9ff; --gold:#ffd479; --rose:#ff8fb3; --good:#9cf3d2;
    --accent1:#b7a9ff; --accent2:#ff6bd6; --accent3:#4af2d8; --accent4:#ffd479;
    --glow: rgba(183,169,255,.45);
    --honey:#ffd479; --honey-deep:#ffb84d; --honey-amber:#ff9f1c;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1100px 700px at 70% -10%, rgba(183,169,255,.15), transparent 70%),
      var(--bg);
    color:var(--ink);
    font:400 16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,ui-sans-serif
  }
  a{color:var(--mint);text-decoration:none}
  .wrap{max-width:1220px;margin:0 auto;padding:24px}

  .selfish-badge{
    position:fixed; left:14px; top:14px; z-index:81;
    padding:8px 10px; border:1px solid var(--ring); border-radius:12px;
    background:linear-gradient(180deg,#1f1531,#14182a); color:var(--ink);
    font-size:12px; display:flex; gap:8px; align-items:center; cursor:pointer;
    box-shadow:0 8px 24px rgba(0,0,0,.35)
  }
  .selfish-badge[aria-pressed="true"]{ outline:2px solid var(--rose); outline-offset:2px }
  .selfish-dot{ width:8px; height:8px; border-radius:50%; background:var(--rose); box-shadow:0 0 10px var(--glow) }

  header{display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap;align-items:center;padding:6px 0 12px}
  h1{margin:0;font-size:clamp(20px,3.6vw,30px)}
  .sub{color:var(--muted);font-size:14px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    border:1px solid var(--ring);border-radius:18px;padding:16px;
    box-shadow:0 8px 28px rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(6px)
  }
  .grid{display:grid;gap:16px}
  @media(min-width:1120px){.grid.cols-2{grid-template-columns:1.2fr .9fr}}

  .btn{
    appearance:none;border:1px solid var(--ring);
    background:linear-gradient(180deg,#16223a,#121a2c);color:var(--ink);
    padding:10px 14px;border-radius:14px;cursor:pointer;font-weight:600;letter-spacing:.2px;
    box-shadow:0 6px 20px rgba(0,0,0,.25)
  }
  .btn.small{padding:8px 10px;font-size:13px;border-radius:12px}
  .btn.alt{background:transparent}
  .btn[aria-pressed="true"]{outline:2px solid var(--mint);outline-offset:2px}

  .yt{position:relative;padding-top:56.25%;border-radius:14px;overflow:hidden;border:1px solid var(--ring);background:#0b1220}
  .yt > div, .yt iframe{position:absolute;inset:0;width:100%;height:100%;border:0}

  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{font-size:12px;padding:6px 8px;border-radius:10px;border:1px solid var(--ring);background:#131c31}
  .list{max-height:300px;overflow:auto;border:1px solid var(--ring);border-radius:12px;padding:8px;background:#0f1729}
  .track{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
  .track:hover{background:#111c34}
  .idx{width:22px;text-align:right;color:var(--muted);font-size:12px}
  .title{flex:1}
  .now{color:var(--gold)}

  .symbols{display:grid;gap:10px;margin-top:10px}
  @media(min-width:760px){ .symbols{grid-template-columns:repeat(4,minmax(0,1fr))} }
  .sym{border:1px solid var(--ring); border-radius:14px; padding:10px; background:#0f1729; display:flex; gap:10px; align-items:flex-start; transition:transform .2s, box-shadow .2s, border-color .2s}
  .sym:hover{ transform:translateY(-2px); border-color:color-mix(in oklab,var(--accent1),white 25%); box-shadow:0 10px 28px rgba(0,0,0,.35) }
  .sym .g{font-size:18px; padding:6px 8px; border-radius:999px; background:color-mix(in oklab,var(--accent1),black 70%); box-shadow:0 8px 18px color-mix(in oklab,var(--accent1),transparent 85%)}
  .sym h4{margin:0 0 4px 0; font-size:14px}

  .honey-wrap{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .honey-btn{
    position:relative; overflow:hidden;
    background: radial-gradient(120% 180% at 20% 0%, var(--honey) 0%, var(--honey-deep) 60%, var(--honey-amber) 100%);
    color:#2a1900; border:0; font-weight:800; letter-spacing:.4px;
    padding:14px 18px; border-radius:16px; cursor:pointer; text-shadow:0 1px 0 rgba(255,255,255,.4);
    box-shadow: 0 8px 26px rgba(255, 168, 0, .25), inset 0 -2px 0 rgba(0,0,0,.15);
  }
  .honey-btn:active{ transform:translateY(1px) }
  .honey-btn .subtxt{display:block; font-size:12px; opacity:.9}
  .honey-btn::before, .honey-btn::after{
    content:""; position:absolute; top:0; left:0; right:0; height:40%; pointer-events:none;
    background: radial-gradient(60% 140% at 30% 0%, rgba(255,255,255,.35), transparent 60%);
    mix-blend-mode:screen; opacity:.6;
  }
  .drip{ position:absolute; width:10px; height:10px; background:var(--honey-amber);
    border-radius:0 0 10px 10px; left:28px; top:40%; box-shadow: 0 2px 0 rgba(0,0,0,.15) inset;
    animation: drip 2.8s infinite ease-in; }
  .drip.d2{ left:56px; animation-duration:3.3s }
  .drip.d3{ left:84px; animation-duration:2.6s }

  .trier{margin-top:6px; font-size:13px; color:var(--muted)}
  .trier.active{ color:var(--gold); text-shadow:0 0 18px rgba(255,212,121,.35) }

  ._off{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }

  .hr{height:1px;background:linear-gradient(90deg,transparent,#26304b,transparent);margin:8px 0}
  footer{margin-top:16px;display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
</style>
</head>
<body>

<button id="selfishToggle" class="selfish-badge" aria-pressed="false" title="It's for her ‚Äî and for me">
  <span class="selfish-dot" aria-hidden="true"></span> Selfish Mode
</button>

<div class="_off">
  <p>Private note: DM <strong>@illumina.t1</strong> on TikTok. Quiet tea near Bryant Park (Wed / Sat afternoons).</p>
</div>

<div class="wrap">
  <header>
    <div>
      <h1 id="title">Honey ‚Äî Sabrina ¬∑ Honey Garden</h1>
      <div class="sub" id="subtitle">School Room: Fun ¬∑ Wit ¬∑ Playful Movement. Tunes-style, honey-coated.</div>
      <div class="symbols" id="symbols"></div>
    </div>
    <div class="pill" id="status"><span id="statusText">Ready</span></div>
  </header>

  <div class="grid cols-2">
    <section class="card">
      <div class="honey-wrap" role="group" aria-label="Audio unlock">
        <button class="honey-btn" id="startAudio">
          Start Honey ‚Äî <span style="font-weight:900">Enable Audio</span>
          <span class="subtxt">one tap to unlock music + tones</span>
          <i class="drip"></i><i class="drip d2"></i><i class="drip d3"></i>
        </button>
        <span class="sub">After tapping once, sound stays enabled.</span>
      </div>

      <div class="row" id="laneButtons" style="margin-top:10px"></div>

      <div class="yt" style="margin-top:12px"><div id="player"></div></div>

      <div class="row" style="margin-top:10px;justify-content:space-between">
        <div class="sub" id="now">Now Playing ‚Äî (queue pre-loaded)</div>
        <div class="row">
          <button class="btn small" id="prev">‚èÆÔ∏é Prev</button>
          <button class="btn small" id="play">‚èµÔ∏é / ‚è∏Ô∏é</button>
          <button class="btn small" id="next">‚è≠Ô∏é Next</button>
          <button class="btn small" id="shuffle" aria-pressed="true">Shuffle: On</button>
          <button class="btn small" id="loop" aria-pressed="false">Loop: Off</button>
          <label class="sub">Vol
            <input id="ytVol" type="range" min="0" max="100" step="1" value="70" style="vertical-align:middle;margin-left:6px"/>
          </label>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="pill" id="laneLabel">Lane: Sabrina</span>
        <span class="pill" id="count">0 tracks</span>
        <span class="pill">Pair with <a href="https://tunes.plnt.earth" target="_blank" rel="noopener">Tunes</a></span>
      </div>

      <div class="list" id="queue" style="margin-top:10px" aria-label="Playlist queue"></div>
    </section>

    <aside class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Honey Tools</h3>
        <span class="pill">I am a trier.</span>
      </div>
      <div class="hr"></div>

      <div class="row">
        <button class="btn small" id="h128Toggle" aria-pressed="false">Start 128 Hz</button>
        <label class="sub">Vol <input id="h128Vol" type="range" min="0" max="1" step="0.01" value="0.30" style="vertical-align:middle;margin-left:6px;width:140px"/></label>
        <span class="pill" id="h128Status">tone: off</span>
      </div>
      <div class="trier" id="trierLine">üçØ Every try hums.</div>

      <div class="hr"></div>

      <div class="row">
        <label class="sub" for="bpm">Metronome</label>
        <input id="bpm" type="range" min="60" max="150" step="1" value="118"/>
        <span class="sub" id="bpmVal">118</span>
        <button class="btn small" id="tick" aria-pressed="false">Tick: Off</button>
        <div class="meter"><i></i></div>
      </div>

      <div class="hr"></div>

      <div>
        <h4 style="margin:0 0 6px">Warmth Placement Test</h4>
        <div class="row" id="warmthTest">
          <button class="btn small" data-room="Prism">Play + Color leads</button>
          <button class="btn small" data-room="Ocean">Bass calms me</button>
          <button class="btn small" data-room="Forest">Green resets me</button>
          <button class="btn small" data-room="Alter">Heat focuses me</button>
        </div>
        <p class="sub" id="warmthResult" style="margin-top:6px"></p>
      </div>

      <div class="hr"></div>

      <div>
        <h4 style="margin:0 0 6px">Honey Class 101 ‚Äî quick syllabus</h4>
        <div class="row" id="syllabusPills" style="align-items:flex-start;gap:8px;flex-wrap:wrap"></div>
      </div>

      <div class="hr"></div>

      <div>
        <h4 style="margin:0 0 6px">Ask Honey</h4>
        <div class="row">
          <input id="askInput" type="text" placeholder="e.g., add a Marina visualizer and shuffle funny Sabrina"/>
          <button class="btn small" id="askGo">Suggest</button>
        </div>
        <ul id="askOut" class="sub" style="margin:6px 0 0 16px"></ul>
      </div>
    </aside>
  </div>

  <footer>
    <div class="sub">¬© PLNT Earth ¬∑ honey.plnt.earth ‚Äî Sabrina first anchor. Honey pairs with everything.</div>
    <div class="row">
      <a class="btn small" href="https://tunes.plnt.earth" rel="noopener">Tunes</a>
      <a class="btn small" href="https://froot.plnt.earth" rel="noopener">Froot</a>
      <a class="btn small" href="https://alter.fire.plnt.earth" rel="noopener">Alter Fire</a>
      <a class="btn small" href="https://mirrorhoney.plnt.earth" rel="noopener">MirrorHoney</a>
    </div>
  </footer>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
(function(){
  const $=id=>document.getElementById(id);
  const qsa=(s,r=document)=>Array.from(r.querySelectorAll(s));

  /* ===== Config ===== */
  const HONEY_JSON_URL = './honey_syllabus.json';

  /* ===== Built-in defaults (safe fallback) ===== */
  const defaults = {
    meta:{ title:'Honey ‚Äî Sabrina ¬∑ Honey Garden', subtitle:'School Room: Fun ¬∑ Wit ¬∑ Playful Movement. Tunes-style, honey-coated.' },
    symbols:[
      {emoji:'üçØ',title:'Honey Anchor',note:'Warms any lane. Sweet courage on beat.'},
      {emoji:'üé≠',title:'Wit',note:'Tag, tease, deliver ‚Äî keep it bright.'},
      {emoji:'üï∫',title:'Play',note:'Body leads, mind smiles. BPM = permission.'},
      {emoji:'‚ú®',title:'School',note:'Light structure ‚Üí brave tries.'}
    ],
    tools:{ tone128:{defaultGain:0.30}, metronome:{defaultBPM:118} },
    syllabus:[
      'Warm up: 128 Hz under one Sabrina track',
      'Movement: 4 minutes at 118 BPM',
      'Wit drill: write one playful tag line',
      'Share: one tiny win'
    ],
    lanes:{
      S:{label:'üçØ Sabrina', tracks:[
        {id:'aSugSGCC12I', title:'Sabrina ‚Äî Espresso'},
        {id:'dR0wWeTX7r0', title:'Sabrina ‚Äî Please Please Please'},
        {id:'bCZFy3O8w0A', title:'Sabrina ‚Äî Feather'},
        {id:'vZL1eY4xw9M', title:'Sabrina ‚Äî Nonsense'}
      ]},
      Mar:{label:'üåô Marina', tracks:[
        {id:'Cr-SqRWImmI', title:'MARINA ‚Äî Oh No!'},
        {id:'gDr7aTfBffU', title:'MARINA ‚Äî Blue'},
        {id:'s6AHxF0s764', title:'MARINA ‚Äî Happy'}
      ]},
      D:{label:'üíû Ariana', tracks:[
        {id:'1ekZEVeXwek', title:'Ariana ‚Äî Into You'},
        {id:'ffxKSjUwKdU', title:'Ariana ‚Äî no tears left to cry'}
      ]}
    }
  };

  /* ===== State (filled by JSON ‚Üí defaults) ===== */
  let SYL = JSON.parse(JSON.stringify(defaults));
  let laneKeys = Object.keys(SYL.lanes);
  let currentLane = laneKeys[0] || 'S';
  let idx=0, shuffleOn=true, loopMode='off';
  let audioUnlocked=false;

  /* ===== Selfish Mode ===== */
  (function(){
    const key='honey_selfish_v1', t=$('selfishToggle'), st=$('subtitle');
    function go(on){
      try{ localStorage.setItem(key,on?'1':'0'); }catch(e){}
      t.setAttribute('aria-pressed', on?'true':'false');
      st.textContent = on ? 'Honey + Selfish Mode: for her ¬∑ and for me' : (SYL.meta.subtitle||defaults.meta.subtitle);
    }
    t.addEventListener('click',()=>go(!(t.getAttribute('aria-pressed')==='true')));
    let s=''; try{s=localStorage.getItem(key)||'';}catch(e){}
    go(s==='1');
  })();

  /* ===== JSON Loader ===== */
  function safe(v, d){ return (v===undefined || v===null) ? d : v; }
  function mergeFromJSON(j){
    try{
      SYL.meta.title   = safe(j.meta && j.meta.title,   SYL.meta.title);
      SYL.meta.subtitle= safe(j.meta && j.meta.subtitle, SYL.meta.subtitle);
      SYL.symbols      = Array.isArray(j.symbols)&&j.symbols.length ? j.symbols : SYL.symbols;
      if(j.tools){
        if(j.tools.tone128 && typeof j.tools.tone128.defaultGain==='number') SYL.tools.tone128.defaultGain=j.tools.tone128.defaultGain;
        if(j.tools.metronome && typeof j.tools.metronome.defaultBPM==='number') SYL.tools.metronome.defaultBPM=j.tools.metronome.defaultBPM;
      }
      SYL.syllabus = Array.isArray(j.syllabus)&&j.syllabus.length ? j.syllabus : SYL.syllabus;
      if(j.lanes && typeof j.lanes==='object'){
        const cleaned={};
        Object.keys(j.lanes).forEach(k=>{
          const L=j.lanes[k]||{};
          const label = typeof L.label==='string' ? L.label : (defaults.lanes[k]?.label || k);
          const tracks = Array.isArray(L.tracks)? L.tracks.filter(t=>t&&t.id) : (defaults.lanes[k]?.tracks || []);
          if(tracks.length) cleaned[k]={label, tracks};
        });
        if(Object.keys(cleaned).length) SYL.lanes=cleaned;
      }
      laneKeys = Object.keys(SYL.lanes);
      currentLane = laneKeys.includes(currentLane) ? currentLane : (laneKeys[0]||currentLane);
    }catch(e){}
  }

  function applyToUI(){
    $('title').textContent = SYL.meta.title || defaults.meta.title;
    $('subtitle').textContent = SYL.meta.subtitle || defaults.meta.subtitle;

    const sym=$('symbols'); sym.innerHTML='';
    SYL.symbols.forEach(s=>{
      const el=document.createElement('div');
      el.className='sym';
      el.innerHTML = '<div class="g">'+(s.emoji||'‚ú®')+'</div><div><h4>'+ (s.title||'') +'</h4><div class="sub">'+ (s.note||'') +'</div></div>';
      sym.appendChild(el);
    });

    const pills=$('syllabusPills'); pills.innerHTML='';
    SYL.syllabus.forEach(item=>{
      const el=document.createElement('div'); el.className='pill'; el.textContent=item; pills.appendChild(el);
    });

    const laneWrap=$('laneButtons'); laneWrap.innerHTML='';
    laneKeys.forEach(k=>{
      const b=document.createElement('button');
      b.className='btn small';
      b.id='lane_'+k;
      b.setAttribute('aria-pressed', k===currentLane?'true':'false');
      b.textContent = SYL.lanes[k].label || k;
      b.addEventListener('click', ()=>{ setLane(k); });
      laneWrap.appendChild(b);
    });

    $('laneLabel').textContent='Lane: '+(SYL.lanes[currentLane].label || currentLane);
    $('bpm').value = SYL.tools.metronome.defaultBPM;
    $('bpmVal').textContent = SYL.tools.metronome.defaultBPM;
    $('h128Vol').value = SYL.tools.tone128.defaultGain;
  }

  /* ===== YouTube Player ===== */
  let player=null, playerReady=false, apiReady=false;
  window.onYouTubeIframeAPIReady=function(){ apiReady=true; };

  function setStatus(msg){ $('statusText').textContent=msg; }
  function activeList(){ return (SYL.lanes[currentLane] && SYL.lanes[currentLane].tracks) || []; }

  function makePlayer(firstId){
    if(player){ try{player.destroy();}catch(e){} player=null; }
    player=new YT.Player('player',{
      videoId:firstId,
      playerVars:{autoplay:1,mute:0,controls:1,rel:0,modestbranding:1,playsinline:1},
      events:{
        onReady:function(){
          playerReady=true;
          try{player.unMute();}catch(e){}
          applyYTVolume();
          try{player.playVideo();}catch(e){}
          setStatus('Ready');
          updateNowTitle();
        },
        onStateChange:function(e){
          if(e.data===YT.PlayerState.PLAYING) updateNowTitle();
          if(e.data===YT.PlayerState.ENDED){
            if(loopMode==='one'){ try{player.seekTo(0);player.playVideo();}catch(e){} }
            else{ idx=nextIndex(); loadCurrent(true); }
          }
        }
      }
    });
  }

  function updateNowTitle(){
    if(!player||!playerReady) return;
    try{
      const data=player.getVideoData();
      const title=(data&&data.title)?data.title:'';
      if(title) $('now').textContent='Now Playing ‚Äî '+title;
    }catch(e){}
  }

  $('startAudio').addEventListener('click',function(){
    audioUnlocked=true;
    const firstId=(activeList()[0]||{}).id || 'aSugSGCC12I';
    if(apiReady){ makePlayer(firstId); resumeHoney128(); }
    else{
      const wait=setInterval(()=>{ if(apiReady){ clearInterval(wait); makePlayer(firstId); resumeHoney128(); } },50);
    }
  });

  function applyYTVolume(){
    if(!playerReady) return;
    const v=Math.max(0,Math.min(100,parseInt($('ytVol').value,10)||0));
    try{ player.setVolume(v); }catch(e){}
  }
  $('ytVol').addEventListener('input',applyYTVolume);

  document.addEventListener('visibilitychange',()=>{
    if(document.visibilityState==='visible' && playerReady && audioUnlocked){
      applyYTVolume(); try{player.playVideo();}catch(e){} updateNowTitle(); resumeHoney128();
    }
  });

  function renderQueue(){
    const list=$('queue'); list.innerHTML='';
    const q=activeList(); $('count').textContent=q.length+' tracks';
    $('laneLabel').textContent='Lane: '+(SYL.lanes[currentLane].label || currentLane);
    q.forEach((t,i)=>{
      const div=document.createElement('div');
      div.className='track'+(i===idx?' now':'');
      div.innerHTML='<div class="idx">'+(i+1)+'</div><div class="title">'+(t.title||t.id)+'</div>';
      div.addEventListener('click',()=>{ idx=i; loadCurrent(true); });
      list.appendChild(div);
    });
  }

  function loadCurrent(autoplay){
    const cur=activeList()[idx]; if(!cur||!playerReady) return;
    try{
      player.loadVideoById({videoId:cur.id,startSeconds:0,suggestedQuality:'hd720'});
      if(audioUnlocked){ player.unMute(); applyYTVolume(); if(autoplay!==false) player.playVideo(); } else { player.mute(); }
    }catch(e){}
    setTimeout(updateNowTitle,250);
    renderQueue();
  }

  function nextIndex(){
    const q=activeList(); if(!q.length) return 0;
    if(loopMode==='one') return idx;
    if(shuffleOn){ if(q.length===1) return 0; let r=Math.floor(Math.random()*q.length); if(r===idx) r=(r+1)%q.length; return r; }
    return (idx+1)%q.length;
  }
  function prevIndex(){
    const q=activeList(); if(!q.length) return 0;
    if(shuffleOn){ if(q.length===1) return 0; let r=Math.floor(Math.random()*q.length); if(r===idx) r=(r+q.length-1)%q.length; return r; }
    return (idx-1+q.length)%q.length;
  }

  function setLane(which){
    currentLane=which; idx=0;
    qsa('#laneButtons .btn').forEach(b=>b.setAttribute('aria-pressed','false'));
    const btn=$('lane_'+which); if(btn) btn.setAttribute('aria-pressed','true');
    renderQueue(); if(playerReady) loadCurrent(true);
  }

  $('prev').addEventListener('click',()=>{ idx=prevIndex(); loadCurrent(true); });
  $('next').addEventListener('click',()=>{ idx=nextIndex(); loadCurrent(true); });
  $('play').addEventListener('click',()=>{ if(!playerReady) return; try{
    const st=player.getPlayerState();
    if(st===YT.PlayerState.PLAYING){ player.pauseVideo(); }
    else { if(audioUnlocked) player.unMute(); applyYTVolume(); player.playVideo(); }
  }catch(e){} });

  $('shuffle').addEventListener('click',function(){
    shuffleOn=!(this.getAttribute('aria-pressed')==='true');
    this.setAttribute('aria-pressed', shuffleOn?'true':'false');
    this.textContent='Shuffle: '+(shuffleOn?'On':'Off');
  });
  $('loop').addEventListener('click',function(){
    if(loopMode==='off'){ loopMode='all'; this.setAttribute('aria-pressed','true'); this.textContent='Loop: All'; }
    else if(loopMode==='all'){ loopMode='one'; this.textContent='Loop: One'; }
    else { this.setAttribute('aria-pressed','false'); this.textContent='Loop: Off'; loopMode='off'; }
  });

  $('askGo').addEventListener('click',()=>{
    const q=($('askInput').value||'').toLowerCase();
    const out=$('askOut'); out.innerHTML='';
    const tips=[];
    if(q.includes('funny')||q.includes('joke')) tips.push('Shuffle Sabrina funny set (Espresso / PPP / Nonsense).');
    laneKeys.forEach(k=>{
      if(q.includes('marina') && k.toLowerCase().includes('mar')) tips.push('Switch to '+(SYL.lanes[k].label||k)+' and start the first track.');
    });
    if(q.includes('calm')) tips.push('Lower YouTube volume to 50 and start 128 Hz at 0.25.');
    if(!tips.length) tips.push('Tip: tap Shuffle and let Honey pick one for you.');
    tips.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; out.appendChild(li); });
  });

  /* ===== Metronome ===== */
  let tCtx,tOsc,tGain,tTimer=null;
  function initTick(){
    if(tCtx) return;
    const AC=window.AudioContext||window.webkitAudioContext;
    tCtx=new AC({latencyHint:'interactive'});
    tOsc=tCtx.createOscillator(); tOsc.type='square';
    tGain=tCtx.createGain(); tGain.gain.value=0;
    tOsc.connect(tGain).connect(tCtx.destination); tOsc.start();
  }
  function ping(){
    if(!tCtx) return;
    tGain.gain.cancelScheduledValues(tCtx.currentTime);
    tGain.gain.setValueAtTime(0.15,tCtx.currentTime);
    tGain.gain.exponentialRampToValueAtTime(0.0001,tCtx.currentTime+0.03);
  }
  function startTick(){ initTick(); const bpm=parseInt($('bpm').value,10)||118; const iv=60000/bpm; clearInterval(tTimer); tTimer=setInterval(ping,iv); }
  function stopTick(){ clearInterval(tTimer); }
  $('bpm').addEventListener('input',function(){ $('bpmVal').textContent=this.value; if(tTimer) startTick(); });
  $('tick').addEventListener('click',function(){
    const on=this.getAttribute('aria-pressed')==='true';
    if(on){ this.setAttribute('aria-pressed','false'); this.textContent='Tick: Off'; stopTick(); }
    else { this.setAttribute('aria-pressed','true'); this.textContent='Tick: On'; startTick(); }
  });

  /* ===== Honey 128 tone ===== */
  let aCtx,g128,h128Osc;
  function initHoney(){
    if(aCtx) return;
    const AC=window.AudioContext||window.webkitAudioContext;
    aCtx=new AC({latencyHint:'interactive'});
    g128=aCtx.createGain(); g128.gain.value=0;
    h128Osc=aCtx.createOscillator(); h128Osc.type='sine'; h128Osc.frequency.value=128;
    h128Osc.connect(g128).connect(aCtx.destination); h128Osc.start();
  }
  function resumeHoney128(){ try{ if(aCtx && aCtx.state==='suspended') aCtx.resume(); }catch(e){} }

  $('h128Toggle').addEventListener('click',function(){
    initHoney(); resumeHoney128();
    const on=this.getAttribute('aria-pressed')==='true';
    const vol=Math.max(0,Math.min(1,parseFloat($('h128Vol').value)||SYL.tools.tone128.defaultGain||0.30));
    if(on){
      this.setAttribute('aria-pressed','false'); this.textContent='Start 128 Hz';
      if(g128) g128.gain.value=0; $('h128Status').textContent='tone: off'; $('trierLine').classList.remove('active');
    }else{
      this.setAttribute('aria-pressed','true'); this.textContent='Stop 128 Hz';
      if(g128) g128.gain.value=vol; $('h128Status').textContent='tone: on'; $('trierLine').classList.add('active');
    }
  });
  $('h128Vol').addEventListener('input',function(){
    const vol=Math.max(0,Math.min(1,parseFloat(this.value)||0));
    if(g128 && $('h128Toggle').getAttribute('aria-pressed')==='true') g128.gain.value=vol;
  });

  /* ===== Warmth Test ===== */
  const res=$('warmthResult');
  $('warmthTest').addEventListener('click',(e)=>{
    const b=e.target.closest('button'); if(!b) return;
    const map={
      Prism:'PRISM: try a bright Sabrina, tone 0.20, shuffle on.',
      Ocean:'OCEAN: lower volume, keep tone 0.25, slow head nod.',
      Forest:'FOREST: one track + stretch, then water.',
      Alter:'ALTER FIRE: volume up a click, 2-minute sprint.'
    };
    res.textContent=map[b.dataset.room]||'All rooms are good.';
  });

  /* ===== Boot (load JSON ‚Üí apply ‚Üí render) ===== */
  function renderQueue(){ const list=$('queue'); list.innerHTML='';
    const q=activeList(); $('count').textContent=q.length+' tracks';
    $('laneLabel').textContent='Lane: '+(SYL.lanes[currentLane].label || currentLane);
    q.forEach((t,i)=>{
      const div=document.createElement('div');
      div.className='track'+(i===idx?' now':'');
      div.innerHTML='<div class="idx">'+(i+1)+'</div><div class="title">'+(t.title||t.id)+'</div>';
      div.addEventListener('click',()=>{ idx=i; loadCurrent(true); });
      list.appendChild(div);
    });
  }

  function setLane(which){
    currentLane=which; idx=0;
    qsa('#laneButtons .btn').forEach(b=>b.setAttribute('aria-pressed','false'));
    const btn=$('lane_'+which); if(btn) btn.setAttribute('aria-pressed','true');
    renderQueue(); if(playerReady) loadCurrent(true);
  }

  function bootUI(){
    applyToUI();
    // attach ids to lane buttons after they exist
    qsa('#laneButtons .btn').forEach(b=>{
      const txt=b.textContent||''; // give deterministic id again
    });
    // Render initial queue
    renderQueue();
  }

  function start(){
    setStatus('Loading‚Ä¶');
    fetch(HONEY_JSON_URL,{cache:'no-store'})
      .then(r=>r.ok?r.json():null)
      .then(j=>{ if(j){ mergeFromJSON(j); }})
      .catch(function(){})
      .finally(function(){
        setStatus('Ready');
        $('title').textContent = SYL.meta.title||defaults.meta.title;
        $('subtitle').textContent = SYL.meta.subtitle||defaults.meta.subtitle;
        // rebuild lane buttons with stable ids
        const laneWrap=$('laneButtons'); laneWrap.innerHTML='';
        laneKeys = Object.keys(SYL.lanes);
        if(!laneKeys.length){ SYL.lanes = defaults.lanes; laneKeys = Object.keys(SYL.lanes); }
        if(!laneKeys.includes(currentLane)) currentLane = laneKeys[0];
        laneKeys.forEach(k=>{
          const b=document.createElement('button');
          b.className='btn small';
          b.id='lane_'+k;
          b.setAttribute('aria-pressed', k===currentLane?'true':'false');
          b.textContent = SYL.lanes[k].label || k;
          b.addEventListener('click', ()=>{ setLane(k); });
          laneWrap.appendChild(b);
        });
        applyToUI();
        renderQueue();
      });
  }

  start();
})();
</script>
</body>
</html>
