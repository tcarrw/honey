<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Honey · Tone Self-Test (Auto)</title>
<meta name="theme-color" content="#0b0d11" media="(prefers-color-scheme: dark)">
<style>
:root{
  --bg:#0a0b10;--ink:#f8f7ff;--muted:#b9b8d6;--rim:rgba(255,255,255,.22);
  --glass:rgba(255,255,255,.07);--glass2:rgba(255,255,255,.12);
  --bee:#ffe895;--amber:#ffb62a;--ok:#6ee7a8;--bad:#ff6b6b;--warn:#ffba6b;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#090a0e 0%,#0a0b10 100%);
  color:var(--ink);font:400 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
.container{max-width:920px;margin:0 auto;padding:22px 14px 80px}
h1{font-size:22px;margin:0 0 8px}
p{margin:6px 0;color:var(--muted)}
.card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.04));
  border:1px solid var(--rim);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
  padding:14px;margin-top:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button,input[type="number"],input[type="range"],label.switch{
  appearance:none;border:none;outline:none;border-radius:12px;background:var(--glass);color:var(--ink);padding:10px 12px;font-size:14px;border:1px solid var(--rim)
}
button{cursor:pointer;background:linear-gradient(180deg,rgba(255,219,120,.18),rgba(255,219,120,.06));border-color:rgba(255,219,120,.45)}
button.ghost{background:transparent;border-style:dashed}
.badge{display:inline-block;background:linear-gradient(180deg,#ffe895,#ffb62a);color:#111;font-weight:700;border-radius:10px;padding:2px 8px;font-size:11px}
.grid{display:grid;gap:12px;grid-template-columns:1fr}
@media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
label{font-size:13px;color:var(--muted)}
small{color:var(--muted)}
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
.table td{background:rgba(255,255,255,.04);border:1px solid var(--rim);padding:8px;border-radius:10px}
.status{display:inline-flex;align-items:center;gap:8px}
.dot{width:10px;height:10px;border-radius:50%}
.ok{background:var(--ok)} .bad{background:var(--bad)} .warn{background:var(--warn)}
.footer{position:fixed;inset:auto 0 0 0;background:linear-gradient(180deg,rgba(10,11,16,0),#0a0b10 35%);border-top:1px solid var(--rim);backdrop-filter:blur(6px)}
.footer-inner{max-width:920px;margin:0 auto;padding:10px 14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.start{display:inline-flex;align-items:center;gap:8px}
.bee{width:18px;height:18px;border-radius:50%;background:linear-gradient(180deg,#ffe895,#ffc54f)}
.kpis{display:flex;gap:10px;flex-wrap:wrap}
.kpi{flex:1 1 140px;background:rgba(255,255,255,.05);border:1px solid var(--rim);border-radius:12px;padding:8px 10px;text-align:center}
.kpi b{display:block;font-size:18px;margin-top:2px}
pre{margin:0;white-space:pre-wrap;background:rgba(255,255,255,.04);border:1px dashed var(--rim);padding:10px;border-radius:10px}
</style>
</head>
<body>
<div class="container">
  <h1>Honey Tone Self-Test <span class="badge">Automatic</span></h1>
  <p>This page auto-runs a 7-step tone check (WebAudio sine → Gain → optional LFO) and shows pass/fail. It mirrors your Honey setup. Run once with a tap (required by iOS).</p>

  <div class="grid">
    <div class="card">
      <h2>Controls</h2>
      <div class="row">
        <button id="run">Run Self-Test</button>
        <button id="start">Start Tone</button>
        <button id="stop" class="ghost">Stop</button>
        <label>Hz <input id="hz" type="number" min="20" max="500" step="0.01" value="128.00"></label>
        <label>Volume <input id="vol" type="range" min="0" max="1" step="0.001" value="0.18"></label>
        <label class="switch"><input id="lfo" type="checkbox" checked> Breath LFO</label>
        <label class="switch"><input id="bg" type="checkbox" checked> Background</label>
        <button data-p="128" class="preset">128</button>
        <button data-p="160" class="preset">160</button>
        <button data-p="256" class="preset">256</button>
      </div>
      <small>Tip: Flip the iPhone mute switch off and set system volume ~60% before testing.</small>
    </div>

```
<div class="card">
  <h2>Results</h2>
  <table class="table" id="results">
    <thead><tr><th>#</th><th>Check</th><th>Status</th><th>Detail</th></tr></thead>
    <tbody></tbody>
  </table>
  <div class="kpis">
    <div class="kpi"><span>Passed</span><b id="passCount">0</b></div>
    <div class="kpi"><span>Failed</span><b id="failCount">0</b></div>
    <div class="kpi"><span>Overall</span><b id="overall">—</b></div>
  </div>
</div>
```

  </div>

  <div class="card">
    <h2>What this verifies</h2>
    <ul>
      <li>AudioContext is created on a user gesture and runs.</li>
      <li>Gain ramp produces audible level (>0.01) and the volume slider moves actual gain.</li>
      <li>Preset buttons change oscillator frequency (128↔160↔256 Hz).</li>
      <li>“Background Off” triggers a stop on hidden; “Background On” keeps playing.</li>
      <li>Stop produces a clean fade to near-silence (≤0.001).</li>
      <li>Settings persist to localStorage and reload.</li>
    </ul>
    <details><summary>Debug snapshot</summary>
      <pre id="snapshot">—</pre>
    </details>
  </div>
</div>

<div class="footer">
  <div class="footer-inner">
    <button id="fStart" class="start"><span class="bee"></span> Start</button>
    <button id="fStop" class="ghost">Stop</button>
    <span class="status"><span id="stateDot" class="dot bad"></span><b id="stateTxt">Idle</b></span>
  </div>
</div>

<script>
(function(){
  "use strict";

  // Shortcuts
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));

  // UI
  const runBtn = qs('#run'), startBtn = qs('#start'), stopBtn = qs('#stop');
  const fStart = qs('#fStart'), fStop = qs('#fStop');
  const hzEl = qs('#hz'), volEl = qs('#vol'), lfoEl = qs('#lfo'), bgEl = qs('#bg');
  const resultsBody = qs('#results tbody'), passCountEl = qs('#passCount'), failCountEl = qs('#failCount'), overallEl = qs('#overall');
  const stateDot = qs('#stateDot'), stateTxt = qs('#stateTxt'), snapshotPre = qs('#snapshot');

  // Storage keys
  const K = { hz:'honey:toneHz', vol:'honey:gain', lfo:'honey:lfo', bg:'honey:bg' };

  // Audio graph
  let ctx, osc, gainNode, lfo, lfoGain;
  let session = 'Idle';
  let testHiddenOverride = null; // for simulated visibility

  function setState(s){
    session = s;
    stateTxt.textContent = s;
    stateDot.className = 'dot ' + (s==='Playing' ? 'ok' : (s.indexOf('Calm')===0 ? 'warn':'bad'));
  }

  function initAudio(){
    if (ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    gainNode = ctx.createGain();
    gainNode.gain.value = 0.0001;

    osc = ctx.createOscillator();
    osc.type = 'sine';
    osc.frequency.value = parseFloat(hzEl.value||'128');

    lfo = ctx.createOscillator();
    lfo.type = 'sine';
    lfo.frequency.value = 0.18;
    lfoGain = ctx.createGain();
    lfoGain.gain.value = lfoEl.checked ? 0.08 : 0;

    lfo.connect(lfoGain);
    lfoGain.connect(gainNode.gain);
    osc.connect(gainNode);
    gainNode.connect(ctx.destination);

    osc.start(); lfo.start();
  }

  function fade(target, ms){
    if (!ctx || !gainNode) return;
    const now = ctx.currentTime;
    const v = Math.max(0, Math.min(1, target));
    gainNode.gain.cancelScheduledValues(now);
    gainNode.gain.setValueAtTime(gainNode.gain.value, now);
    gainNode.gain.linearRampToValueAtTime(v, now + ms/1000);
  }

  function startTone(){
    initAudio();
    if (ctx.state !== 'running') ctx.resume();
    osc.frequency.setValueAtTime(parseFloat(hzEl.value||'128'), ctx.currentTime);
    fade(parseFloat(volEl.value||'0.18'), 600);
    setState('Playing');
    saveSettings();
  }

  function stopTone(){
    if (!ctx) return;
    fade(0.0001, 400);
    setState('Idle');
  }

  function saveSettings(){
    localStorage.setItem(K.hz, hzEl.value);
    localStorage.setItem(K.vol, volEl.value);
    localStorage.setItem(K.lfo, lfoEl.checked ? '1':'0');
    localStorage.setItem(K.bg, bgEl.checked ? '1':'0');
  }
  function loadSettings(){
    const a = localStorage.getItem(K.hz); if (a) hzEl.value = a;
    const b = localStorage.getItem(K.vol); if (b) volEl.value = b;
    const c = localStorage.getItem(K.lfo); if (c) lfoEl.checked = (c==='1');
    const d = localStorage.getItem(K.bg); if (d) bgEl.checked = (d==='1');
  }

  // Visibility handler (real + simulated)
  function handleVisibility(){
    const hidden = (testHiddenOverride !== null) ? testHiddenOverride : document.hidden;
    if (hidden && !bgEl.checked) stopTone();
  }
  document.addEventListener('visibilitychange', handleVisibility);

  // Wire UI
  startBtn.addEventListener('click', startTone);
  fStart.addEventListener('click', startTone);
  stopBtn.addEventListener('click', stopTone);
  fStop.addEventListener('click', stopTone);

  hzEl.addEventListener('change', ()=>{
    saveSettings();
    if (osc && ctx) osc.frequency.setValueAtTime(parseFloat(hzEl.value||'128'), ctx.currentTime);
  });
  volEl.addEventListener('input', ()=>{
    saveSettings();
    if (ctx && gainNode){
      const v = parseFloat(volEl.value||'0.18');
      gainNode.gain.setTargetAtTime(v, ctx.currentTime, 0.12);
    }
  });
  lfoEl.addEventListener('change', ()=>{
    saveSettings();
    if (lfoGain && ctx) lfoGain.gain.setValueAtTime(lfoEl.checked ? 0.08 : 0, ctx.currentTime);
  });
  bgEl.addEventListener('change', saveSettings);

  qsa('.preset').forEach(b=>{
    b.addEventListener('click', ()=>{
      const p = parseFloat(b.getAttribute('data-p'));
      hzEl.value = p.toFixed(2);
      saveSettings();
      if (osc && ctx) osc.frequency.setValueAtTime(p, ctx.currentTime);
    });
  });

  // ---------- Auto Test Runner ----------
  const checks = [
    {name:'User-gesture start → audible gain', run: async () => {
      startTone();
      await wait(700);
      const ok = (ctx && ctx.state==='running' && (gainNode.gain.value > 0.01));
      return ok ? pass() : fail('gain='+(gainNode?gainNode.gain.value:'—'));
    }},
    {name:'Volume control moves actual gain', run: async () => {
      volEl.value = '0.35'; volEl.dispatchEvent(new Event('input'));
      await wait(250);
      const g = gainNode?gainNode.gain.value:0;
      return (g>0.30 && g<0.40) ? pass() : fail('gain='+g.toFixed(3));
    }},
    {name:'Preset pitch change (128↔160)', run: async () => {
      hzEl.value='160.00'; hzEl.dispatchEvent(new Event('change')); await wait(120);
      const a = Math.abs(osc.frequency.value-160) < 0.01;
      hzEl.value='128.00'; hzEl.dispatchEvent(new Event('change')); await wait(120);
      const b = Math.abs(osc.frequency.value-128) < 0.01;
      return (a && b) ? pass() : fail('freq='+osc.frequency.value.toFixed(2));
    }},
    {name:'Background OFF → stop on hidden', run: async () => {
      bgEl.checked = false; saveSettings();
      startTone(); await wait(200);
      testHiddenOverride = true; handleVisibility(); await wait(200);
      const g = gainNode?gainNode.gain.value:1;
      testHiddenOverride = null;
      return (g <= 0.002) ? pass() : fail('gain='+g.toFixed(3));
    }},
    {name:'Background ON → keep playing hidden', run: async () => {
      bgEl.checked = true; saveSettings();
      startTone(); await wait(200);
      const before = gainNode?gainNode.gain.value:0;
      testHiddenOverride = true; handleVisibility(); await wait(250);
      const after = gainNode?gainNode.gain.value:0;
      testHiddenOverride = null;
      return (after >= before-0.01) ? pass() : fail('gain_before='+before.toFixed(3)+' after='+after.toFixed(3));
    }},
    {name:'Stop → clean fade to near-silence', run: async () => {
      stopTone(); await wait(500);
      const g = gainNode?gainNode.gain.value:1;
      return (g <= 0.0015) ? pass() : fail('gain='+g.toFixed(4));
    }},
    {name:'Settings persist (localStorage)', run: async () => {
      hzEl.value='256.00'; volEl.value='0.22'; lfoEl.checked=false; saveSettings();
      hzEl.value=''; volEl.value=''; lfoEl.checked=true;
      loadSettings();
      const ok = (hzEl.value==='256.00' && Math.abs(parseFloat(volEl.value)-0.22)<0.001 && lfoEl.checked===false);
      return ok ? pass() : fail('hz='+hzEl.value+' vol='+volEl.value+' lfo='+lfoEl.checked);
    }},
  ];

  runBtn.addEventListener('click', async ()=>{
    clearResults();
    loadSettings();
    const out = [];
    for (let i=0;i<checks.length;i++){
      const r = await checks[i].run();
      out.push(renderRow(i+1, checks[i].name, r.ok, r.detail));
    }
    resultsBody.innerHTML = out.join('');
    summarize();
    snapshot();
  });

  // Helpers
  function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function pass(detail='OK'){ return {ok:true, detail}; }
  function fail(detail='Failed'){ return {ok:false, detail}; }
  function renderRow(i,name,ok,detail){
    const cls = ok?'ok':'bad';
    return `<tr>
      <td>${i}</td>
      <td>${escape(name)}</td>
      <td><span class="status"><span class="dot ${cls}"></span>${ok?'Pass':'Fail'}</span></td>
      <td>${escape(detail)}</td>
    </tr>`;
  }
  function clearResults(){ resultsBody.innerHTML=''; passCountEl.textContent='0'; failCountEl.textContent='0'; overallEl.textContent='—'; }
  function summarize(){
    const rows = resultsBody.querySelectorAll('tr');
    let p=0,f=0; rows.forEach(r=>{ const s = r.children[2].innerText.trim(); if (s==='Pass') p++; else f++; });
    passCountEl.textContent = p; failCountEl.textContent = f;
    overallEl.textContent = f===0 ? '✅ Ready' : (p>=5 ? '⚠️ Partial' : '❌ Blocked');
  }
  function snapshot(){
    const snap = {
      ctx: ctx?ctx.state:'none',
      freq: osc?osc.frequency.value:null,
      gain: gainNode?Number(gainNode.gain.value.toFixed(4)):null,
      lfoDepth: lfoGain?Number(lfoGain.gain.value.toFixed(4)):null,
      lfoOn: lfoEl.checked,
      bg: bgEl.checked,
      stored: {
        hz: localStorage.getItem(K.hz),
        vol: localStorage.getItem(K.vol),
        lfo: localStorage.getItem(K.lfo),
        bg: localStorage.getItem(K.bg)
      }
    };
    snapshotPre.textContent = JSON.stringify(snap,null,2);
  }
  function escape(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]); }

  // Boot
  loadSettings();
})();
</script>

</body>
</html>
